{% extends "base.html" %}

{% block title %}Confirming Payment...{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card border-0 shadow">
                <div class="card-body p-5 text-center">
                    <!-- Loading State -->
                    <div id="waiting-state">
                        <div class="mb-4">
                            <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <h3 class="mb-3">Confirming Your Payment</h3>
                        <p class="text-muted mb-3">
                            Waiting for payment confirmation from Ecocash...
                        </p>
                        <p class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            You should see a payment prompt on your phone.
                        </p>
                        <p class="text-muted small">
                            This page will automatically refresh. Do not close this page.
                        </p>
                    </div>
                    
                    <!-- Success State -->
                    <div id="success-state" style="display: none;">
                        <div class="mb-4">
                            <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                        </div>
                        <h3 class="mb-3 text-success">Payment Successful!</h3>
                        <p class="text-muted mb-4">
                            Your subscription is now active. You can start using all plan features.
                        </p>
                        <a href="{{ url_for('billing.billing_dashboard') }}" class="btn btn-success btn-lg">
                            Go to Billing Dashboard
                        </a>
                    </div>
                    
                    <!-- Failure State -->
                    <div id="failure-state" style="display: none;">
                        <div class="mb-4">
                            <i class="fas fa-times-circle text-danger" style="font-size: 3rem;"></i>
                        </div>
                        <h3 class="mb-3 text-danger">Payment Failed</h3>
                        <p class="text-muted mb-4">
                            Your payment could not be processed. Please try again.
                        </p>
                        <a href="{{ url_for('billing.pricing') }}" class="btn btn-primary btn-lg">
                            Back to Plans
                        </a>
                    </div>
                    
                    <!-- Timeout State -->
                    <div id="timeout-state" style="display: none;">
                        <div class="mb-4">
                            <i class="fas fa-hourglass-end text-warning" style="font-size: 3rem;"></i>
                        </div>
                        <h3 class="mb-3 text-warning">Confirmation Timeout</h3>
                        <p class="text-muted mb-4">
                            The payment is still being processed. You can close this page.
                            An email confirmation will be sent when ready.
                        </p>
                        <a href="{{ url_for('billing.billing_dashboard') }}" class="btn btn-secondary btn-lg">
                            Go to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-refresh status every 2 seconds
let checkCount = 0;
const maxChecks = 30; // 1 minute timeout (30 * 2 seconds)
const transactionId = '{{ transaction_id }}';

function checkPaymentStatus() {
    fetch(`/billing/ecocash-check-status/${transactionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showSuccess();
            } else if (data.status === 'failed') {
                showFailure();
            } else if (data.status === 'pending') {
                checkCount++;
                if (checkCount >= maxChecks) {
                    showTimeout();
                } else {
                    // Keep checking
                    setTimeout(checkPaymentStatus, 2000);
                }
            }
        })
        .catch(error => {
            console.error('Status check error:', error);
            // Retry on error
            checkCount++;
            if (checkCount < maxChecks) {
                setTimeout(checkPaymentStatus, 2000);
            } else {
                showTimeout();
            }
        });
}

function showSuccess() {
    document.getElementById('waiting-state').style.display = 'none';
    document.getElementById('success-state').style.display = 'block';
}

function showFailure() {
    document.getElementById('waiting-state').style.display = 'none';
    document.getElementById('failure-state').style.display = 'block';
}

function showTimeout() {
    document.getElementById('waiting-state').style.display = 'none';
    document.getElementById('timeout-state').style.display = 'block';
}

// Start checking immediately
checkPaymentStatus();

// Also refresh page every 10 seconds in case of page reload
setTimeout(() => location.reload(), 10000);
</script>
{% endblock %}
