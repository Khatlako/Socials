{% extends "base.html" %}

{% block title %}{{ post.id }} - Socials{% endblock %}

{% block content %}
<div class="post-view-container p-4">
    <div class="row g-4">
        <!-- Post Content -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Post Details</h5>
                    <span class="badge bg-{{ 'warning' if post.status == 'pending' else 'success' if post.status == 'posted' else 'secondary' }}">
                        {{ post.status.upper() }}
                    </span>
                </div>
                <div class="card-body">
                    <div class="post-preview mb-4">
                        <div class="preview-header">
                            <img src="{{ current_user.profile_picture }}" class="rounded-circle" style="width: 40px;">
                            <div>
                                <strong>{{ current_user.name }}</strong>
                                <small class="text-muted d-block">{{ post.created_at.strftime('%b %d, %Y at %H:%M') }}</small>
                            </div>
                        </div>
                        <div class="preview-content mt-3">
                            {{ post.content }}
                        </div>
                        {% if post.hashtags %}
                        <div class="mt-3 text-primary">
                            {{ post.hashtags }}
                        </div>
                        {% endif %}
                        {% if post.media_items %}
                        <div class="post-media mt-3">
                            {% for media in post.media_items %}
                            <img src="{{ media.file_path }}" class="rounded" style="max-width: 100%; margin-bottom: 10px;">
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    {% if post.status == 'posted' and post.facebook_url %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Posted to Facebook
                        <a href="{{ post.facebook_url }}" target="_blank" class="alert-link">View on Facebook</a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Analytics (if posted) -->
            {% if analytics %}
            <div class="card mt-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Engagement Metrics</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="metric">
                                <i class="fas fa-heart text-danger"></i>
                                <div>
                                    <h6 class="text-muted mb-0">Likes</h6>
                                    <h3>{{ analytics.likes }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric">
                                <i class="fas fa-comment text-info"></i>
                                <div>
                                    <h6 class="text-muted mb-0">Comments</h6>
                                    <h3>{{ analytics.comments }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric">
                                <i class="fas fa-share text-success"></i>
                                <div>
                                    <h6 class="text-muted mb-0">Shares</h6>
                                    <h3>{{ analytics.shares }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric">
                                <i class="fas fa-eye text-primary"></i>
                                <div>
                                    <h6 class="text-muted mb-0">Reach</h6>
                                    <h3>{{ analytics.reach }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Actions Sidebar -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Actions</h5>
                </div>
                <div class="card-body">
                    {% if post.status == 'pending' %}
                    <button class="btn btn-success w-100 mb-2" onclick="approvePost()">
                        <i class="fas fa-check"></i> Approve
                    </button>
                    <button class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#scheduleModal">
                        <i class="fas fa-calendar"></i> Schedule
                    </button>
                    <button class="btn btn-info w-100 mb-2" onclick="publishNow()">
                        <i class="fab fa-facebook"></i> Post Now
                    </button>
                    <a href="{{ url_for('posts.edit', post_id=post.id) }}" class="btn btn-outline-primary w-100 mb-2">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    <button class="btn btn-outline-danger w-100" data-bs-toggle="modal" data-bs-target="#rejectModal">
                        <i class="fas fa-times"></i> Reject
                    </button>
                    {% elif post.status == 'approved' %}
                    <button class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#scheduleModal">
                        <i class="fas fa-calendar"></i> Schedule
                    </button>
                    <button class="btn btn-info w-100 mb-2" onclick="publishNow()">
                        <i class="fab fa-facebook"></i> Post Now
                    </button>
                    <a href="{{ url_for('posts.edit', post_id=post.id) }}" class="btn btn-outline-primary w-100 mb-2">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    {% endif %}
                    
                    {% if post.status != 'posted' %}
                    <button class="btn btn-outline-danger w-100" data-bs-toggle="modal" data-bs-target="#deleteModal">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- Post Info -->
            <div class="card mt-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Post Info</h5>
                </div>
                <div class="card-body">
                    <div class="info-row">
                        <span>Type:</span>
                        <strong>{{ post.post_type.replace('_', ' ').title() }}</strong>
                    </div>
                    {% if post.ai_model_used %}
                    <div class="info-row">
                        <span>AI Model:</span>
                        <strong>{{ post.ai_model_used }}</strong>
                    </div>
                    {% endif %}
                    <div class="info-row">
                        <span>Created:</span>
                        <strong>{{ post.created_at.strftime('%Y-%m-%d') }}</strong>
                    </div>
                    <div class="info-row">
                        <span>Edit Count:</span>
                        <strong>{{ post.edit_count }}</strong>
                    </div>
                    {% if post.facebook_post_id %}
                    <div class="info-row">
                        <span>Facebook ID:</span>
                        <strong><small>{{ post.facebook_post_id }}</small></strong>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Schedule Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="datetime-local" id="scheduledTime" class="form-control">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="schedulePost()">Schedule</button>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="rejectReason" placeholder="Reason for rejection..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="rejectPost()">Reject</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this post? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deletePost()">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
function approvePost() {
    fetch('{{ url_for("posts.approve", post_id=post.id) }}', {method: 'POST'})
        .then(r => r.json())
        .then(d => {
            if (d.success) location.reload();
        });
}

function publishNow() {
    if (confirm('Publish this post to Facebook now?')) {
        fetch('{{ url_for("posts.publish", post_id=post.id) }}', {method: 'POST'})
            .then(r => r.json())
            .then(d => {
                if (d.success) location.reload();
            });
    }
}

function schedulePost() {
    const time = document.getElementById('scheduledTime').value;
    fetch('{{ url_for("posts.schedule", post_id=post.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({scheduled_time: time})
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) location.reload();
    });
}

function rejectPost() {
    const reason = document.getElementById('rejectReason').value;
    fetch('{{ url_for("posts.reject", post_id=post.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({reason: reason})
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) location.reload();
    });
}

function deletePost() {
    fetch('{{ url_for("posts.delete", post_id=post.id) }}', {method: 'POST'})
        .then(r => r.json())
        .then(d => {
            if (d.success) location.href = '{{ url_for("posts.index") }}';
        });
}
</script>

<style>
.post-preview {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    border: 1px solid #e9ecef;
}

.metric {
    display: flex;
    align-items: center;
    gap: 10px;
}

.metric i {
    font-size: 24px;
}

.info-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #e9ecef;
}

.info-row:last-child {
    border-bottom: none;
}
</style>
{% endblock %}
