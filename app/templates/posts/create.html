{% extends "base.html" %}

{% block title %}Create Post - Socials{% endblock %}

{% block content %}
<div class="create-post-container p-4">
    <h2 class="mb-4">Create New Post</h2>

    <div class="row g-4">
        <!-- Editor -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Post Content</h5>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label class="form-label">Post Content</label>
                            <textarea class="form-control post-textarea" name="content" placeholder="Write your post content..." required></textarea>
                            <small class="text-muted">{{ '<span class="char-count">0</span> / 2200' }}</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Hashtags</label>
                            <input type="text" class="form-control" name="hashtags" placeholder="#example #socialmedia #business">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Attach Media</label>
                            <div class="media-selector">
                                <div class="selected-media" id="selectedMedia"></div>
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#mediaModal">
                                    <i class="fas fa-plus"></i> Add Media
                                </button>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" name="action" value="save">
                                <i class="fas fa-save"></i> Save to Pending
                            </button>
                            <a href="{{ url_for('posts.index') }}" class="btn btn-outline-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Preview & Media -->
        <div class="col-lg-4">
            <!-- Preview -->
            <div class="card mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Preview</h5>
                </div>
                <div class="card-body">
                    <div class="facebook-preview">
                        <div class="preview-header">
                            <div class="preview-avatar"></div>
                            <div class="preview-info">
                                <strong>{{ current_user.name }}</strong>
                                <small>Now</small>
                            </div>
                        </div>
                        <div class="preview-content" id="previewContent">
                            Start typing to see preview...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Info -->
            <div class="card">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Tips</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled small">
                        <li><i class="fas fa-check text-success"></i> Keep posts under 280 characters for best engagement</li>
                        <li><i class="fas fa-check text-success"></i> Use 3-5 relevant hashtags</li>
                        <li><i class="fas fa-check text-success"></i> Post at optimal times (9am-5pm weekdays)</li>
                        <li><i class="fas fa-check text-success"></i> Include images/videos for higher engagement</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Media Selection Modal -->
<div class="modal fade" id="mediaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Media</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#existing">Existing Media</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#upload">Upload New</a>
                    </li>
                </ul>

                <div class="tab-content">
                    <div id="existing" class="tab-pane fade show active">
                        <div class="media-grid" id="mediaGrid">
                            Loading media...
                        </div>
                    </div>
                    <div id="upload" class="tab-pane fade">
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag media here or click to upload</p>
                            <input type="file" id="mediaFile" hidden accept="image/*,video/*">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Character counter
document.querySelector('.post-textarea').addEventListener('input', function() {
    document.querySelector('.char-count').textContent = this.value.length;
    document.getElementById('previewContent').textContent = this.value;
});

// Load existing media
fetch('{{ url_for("api.get_media") }}')
    .then(r => r.json())
    .then(media => {
        let html = '<div class="row g-2">';
        media.forEach(m => {
            html += `<div class="col-4">
                <div class="media-item" onclick="selectMedia(${m.id}, '${m.filename}')">
                    <img src="${m.thumbnail_path}" alt="${m.filename}">
                </div>
            </div>`;
        });
        html += '</div>';
        document.getElementById('mediaGrid').innerHTML = html;
    });

function selectMedia(mediaId, filename) {
    const selectedMedia = document.getElementById('selectedMedia');
    const item = document.createElement('div');
    item.className = 'selected-media-item';
    item.innerHTML = `
        <span>${filename}</span>
        <input type="hidden" name="media_ids[]" value="${mediaId}">
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    selectedMedia.appendChild(item);
}
</script>

<style>
.post-textarea {
    min-height: 200px;
    resize: none;
    font-size: 16px;
}

.facebook-preview {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial;
}

.preview-header {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.preview-avatar {
    width: 40px;
    height: 40px;
    background: #ddd;
    border-radius: 50%;
}

.preview-info {
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.preview-info strong {
    display: block;
    font-size: 13px;
}

.preview-info small {
    color: #65676b;
    font-size: 12px;
}

.preview-content {
    color: #50555b;
    font-size: 15px;
    line-height: 1.5;
    word-wrap: break-word;
    max-height: 200px;
    overflow-y: auto;
}

.media-item {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s ease;
}

.media-item:hover {
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.media-item img {
    width: 100%;
    height: 100px;
    object-fit: cover;
}

.selected-media-item {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: #e7e5ff;
    padding: 8px 12px;
    border-radius: 20px;
    margin-right: 8px;
    margin-bottom: 8px;
}

.upload-area {
    border: 2px dashed #667eea;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.upload-area:hover {
    background: #f0f4ff;
}

.upload-area i {
    font-size: 48px;
    color: #667eea;
    margin-bottom: 15px;
}
</style>
{% endblock %}
